"use strict";angular.module("animates.angular-timeline",[]).directive("animatesTimelinepoint",function($document){return{restrict:"E",template:"",scope:{timelineTick:"=",point:"=",eventData:"=",isDisable:"=",pointMove:"&",pointClick:"&",multiplepointeventSelected:"&"},link:{pre:function($scope,element){element.css({left:$scope.point.tick+"px"})},post:function($scope,element){function elementMove(event){var newTick=event.pageX-x;newTick>0&&(point.tick=newTick,element.css({left:newTick+"px"}))}function elementMoveEnd(){$document.unbind("mousemove",elementMove),$document.unbind("mouseup",elementMoveEnd),element.css({"z-index":originalZIndex}),$scope.pointMove({pointData:point.data,newTick:point.tick})}var x,originalZIndex,point=$scope.point;element.on("click",function(){$scope.isDisable||($scope.pointClick({eventData:$scope.eventData,pointData:point.data}),$scope.multiplepointeventSelected({eventData:$scope.eventData}))}),element.on("mousedown",function(event){$scope.isDisable||(event.preventDefault(),x=event.pageX-point.tick,originalZIndex=element.css("z-index"),element.css({"z-index":1e3}),$document.on("mousemove",elementMove),$document.on("mouseup",elementMoveEnd))})}}}}).directive("animatesTimelineevent",function($document){return{restrict:"E",template:'<span class="left" ng-class="{cursor: !isDisable, highlight: evt.start === timelineTick}"></span><span class="center" ng-class="{cursor: !isDisable}"></span><span class="right" ng-class="{cursor: !isDisable, highlight: (evt.start + evt.duration) === timelineTick}"></span>',scope:{evt:"=",isDisable:"=",eventStartchange:"&",eventDurationchange:"&",timelineTick:"=",eventClick:"&"},link:function($scope,element){function elementMove(event){var newStart=event.pageX-x;newStart>0&&(evt.start=newStart,element.css({left:newStart+"px"}))}function elementMoveEnd(){$document.unbind("mousemove",elementMove),$document.unbind("mouseup",elementMoveEnd),element.css({"z-index":originalZIndex}),$scope.eventStartchange({eventData:evt.data,newStartTick:evt.start})}function elementExpandFront(event){var newStart=event.pageX-x,newDuration=originalEndPosition-newStart;newStart>0&&newDuration>0&&(evt.duration=newDuration,evt.start=newStart,element.css({left:newStart+"px",width:newDuration+"px"}),centerElement.css({width:newDuration-border+"px"}))}function elementExpandFrontEnd(){$document.unbind("mousemove",elementExpandFront),$document.unbind("mouseup",elementExpandFrontEnd),element.css({"z-index":originalZIndex}),$scope.eventStartchange({eventData:evt.data,newStartTick:evt.start}),$scope.eventDurationchange({eventData:evt.data,newDuration:evt.duration})}function elementExpandBack(event){var newStart=event.pageX-x,newDuration=newStart-evt.start+originalDuration;newDuration>0&&(evt.duration=newDuration,element.css({width:newDuration+"px"}),centerElement.css({width:newDuration-border+"px"}))}function elementExpandBackEnd(){$document.unbind("mousemove",elementExpandBack),$document.unbind("mouseup",elementExpandBackEnd),element.css({"z-index":originalZIndex}),$scope.eventDurationchange({eventData:$scope.evt.data,newDuration:evt.duration})}var x,originalDuration,originalZIndex,originalEndPosition,evt=$scope.evt,leftElement=angular.element(element[0].querySelector(".left")),centerElement=angular.element(element[0].querySelector(".center")),rightElement=angular.element(element[0].querySelector(".right")),border=30;element.css({left:evt.start+"px",width:evt.duration+"px"}),centerElement.css({width:evt.duration-border+"px"}),element.addClass(evt.class),element.on("click",function(){$scope.isDisable||$scope.eventClick({eventData:evt.data})}),leftElement.on("mousedown",function(event){$scope.isDisable||(event.preventDefault(),x=event.pageX-evt.start,originalDuration=evt.duration,originalZIndex=element.css("z-index"),originalEndPosition=evt.start+evt.duration,element.css({"z-index":1e3}),$document.on("mousemove",elementExpandFront),$document.on("mouseup",elementExpandFrontEnd))}),rightElement.on("mousedown",function(event){$scope.isDisable||(event.preventDefault(),x=event.pageX-evt.start,originalDuration=evt.duration,originalZIndex=element.css("z-index"),element.css({"z-index":1e3}),$document.on("mousemove",elementExpandBack),$document.on("mouseup",elementExpandBackEnd))}),centerElement.on("mousedown",function(event){$scope.isDisable||(event.preventDefault(),x=event.pageX-evt.start,originalDuration=evt.duration,originalZIndex=element.css("z-index"),element.css({"z-index":1e3}),$document.on("mousemove",elementMove),$document.on("mouseup",elementMoveEnd))})}}}).directive("animatesTimeline",function(){return{restrict:"E",template:'<div class="timeline-content"><animates-timelinepoint class="timeline-point" ng-repeat="point in line.points" point="point" event-data="line.data" is-disable="isDisable" ng-class="{cursor: !isDisable, highlight: timelineTick === point.tick}" timeline-tick="timelineTick"point-move="internalPointMove(pointData, newTick)" point-click="internalPointClick(pointData)" multiplepointevent-selected="internalMultiplePointEventSelected(eventData)"></animates-timelinepoint><animates-timelineevent class="timeline-event" ng-repeat="event in line.events" evt="event" timeline-tick="timelineTick" is-disable="isDisable" ng-class="{highlight : (timelineTick >= event.start) && (timelineTick <= (event.start + event.duration))}"event-startchange="internalEventStartChange(eventData, newStartTick)" event-durationchange="internalEventDurationChange(eventData, newDuration)" event-click="internalEventClick(eventData)"> </animates-timelineevent></div>',scope:{line:"=data",timelineData:"=",isDisable:"=",eventStartchange:"&",eventDurationchange:"&",eventClick:"&",pointMove:"&",pointClick:"&",multiplepointeventSelected:"&",maxTick:"=",timelineTick:"="},controller:function($scope){$scope.internalEventStartChange=function(eventData,newStartTick){$scope.eventStartchange&&$scope.eventStartchange({timelineData:$scope.timelineData,eventData:eventData,newStartTick:newStartTick})},$scope.internalEventDurationChange=function(eventData,newDuration){$scope.eventDurationchange&&$scope.eventDurationchange({timelineData:$scope.timelineData,eventData:eventData,newDuration:newDuration})},$scope.internalEventClick=function(eventData){$scope.eventClick&&$scope.eventClick({timelineData:$scope.timelineData,eventData:eventData})},$scope.internalPointMove=function(pointData,newTick){$scope.pointMove&&$scope.pointMove({timelineData:$scope.timelineData,pointData:pointData,newTick:newTick})},$scope.internalPointClick=function(pointData){$scope.pointClick&&$scope.pointClick({timelineData:$scope.timelineData,pointData:pointData})},$scope.internalMultiplePointEventSelected=function(eventData){$scope.multiplepointeventSelected&&$scope.multiplepointeventSelected({timelineData:$scope.timelineData,eventData:eventData})}},link:function($scope,element){$scope.line.points&&element.addClass("points"),$scope.line.events&&element.addClass("events")}}}).directive("animatesTimelines",function($timeout,$document){return{restrict:"E",template:'<div class="timelines-tick-navigator"><div class="tickHandlerHeader" ></div><div class="tickHandlerScrollerContainer" ><div class="tickHandlerContainer" style="width:{{maxTick}}px;"><div class="tickHandler" style="left:{{tick-5}}px;" ng-class="{cursor: !isDisable}"></div></div></div></div><div class="timelines-group"><div class="timelinesHeaders"><div ng-repeat="timeline in data" class="timeline-part timeline-header" data="timeline.data" rel="{{$index}}"><span class="timeline-header-track" title="timeline.name" >{{timeline.name}}</span></div></div><div class="timelinesContainer"><div class="verticalLine" style="left:{{tick}}px"></div><div ng-repeat="timeline in data" class="timeline-part timeline" data="timeline.data"><div class="elementLinesContainer" rel="{{$index}}" style="width:{{maxTick}}px;"><animates-timeline ng-repeat="line in timeline.lines" data="line" timeline-data="timeline.data" timeline-tick="tick" max-tick="maxTick" is-disable="isDisable"point-move="internalPointMove(timelineData, pointData, newTick)" point-click="internalPointClick(timelineData, pointData)" multiplepointevent-selected="internalMultiplePointEventSelected(timelineData, eventData)" event-startchange="internalEventStartChange(timelineData, eventData, newStartTick)" event-durationchange="internalEventDurationChange(timelineData, eventData, newDuration)" event-click="internalEventClick(timelineData, eventData)" > </animates-timeline></div></div></div></div>',scope:{data:"=",externalTick:"=tick",isDisable:"=",tickChange:"&",eventStartchange:"&",eventDurationchange:"&",eventClick:"&",pointMove:"&",pointClick:"&",multiplepointeventSelected:"&"},controller:function($scope){$scope.tick=$scope.externalTick,$scope.maxTick=5e3,$scope.$watch("externalTick",function(){$scope.tick=$scope.externalTick,$scope.tickChange&&$scope.tickChange({tick:$scope.tick})}),$scope.internalTickChange=function(){$scope.$apply(function(){$scope.externalTick=$scope.tick}),$scope.tickChange&&$scope.tickChange({tick:$scope.tick})},$scope.internalEventStartChange=function(timelineData,eventData,newStartTick){$scope.eventStartchange&&$scope.eventStartchange({timelineData:timelineData,eventData:eventData,newStartTick:newStartTick})},$scope.internalEventDurationChange=function(timelineData,eventData,newDuration){$scope.eventDurationchange&&$scope.eventDurationchange({timelineData:timelineData,eventData:eventData,newDuration:newDuration})},$scope.internalEventClick=function(timelineData,eventData){$scope.eventClick&&$scope.eventClick({timelineData:timelineData,eventData:eventData})},$scope.internalPointMove=function(timelineData,pointData,newTick){$scope.pointMove&&$scope.pointMove({timelineData:timelineData,pointData:pointData,newTick:newTick})},$scope.internalPointClick=function(timelineData,pointData){$scope.pointClick&&$scope.pointClick({timelineData:timelineData,pointData:pointData})},$scope.internalMultiplePointEventSelected=function(timelineData,eventData){$scope.multiplepointeventSelected&&$scope.multiplepointeventSelected({timelineData:timelineData,eventData:eventData})}},link:function($scope,element){function tickHandlerMove(event){var delta,newTick=event.pageX-x;newTick>0&&($scope.$apply(function(){$scope.tick=newTick}),delta=originalTick-newTick,(delta>5||-5>delta)&&(originalTick=newTick,$scope.internalTickChange()))}function tickHandlerMoveEnd(){$document.unbind("mousemove",tickHandlerMove),$document.unbind("mouseup",tickHandlerMoveEnd),originalTick!==$scope.tick&&$scope.internalTickChange()}$timeout(function(){angular.forEach(element[0].querySelectorAll(".elementLinesContainer"),function(timeline){var id=angular.element(timeline).attr("rel"),height=angular.element(timeline)[0].offsetHeight;element[0].querySelector('.timeline-header[rel="'+id+'"]').style.height=height-1+"px"})});var x,originalTick,tickHandlerElement=angular.element(element[0].querySelector(".tickHandler")),timelineContainerElement=angular.element(element[0].querySelector(".timelinesContainer")),tickHandlerScrollerContainerElement=angular.element(element[0].querySelector(".tickHandlerScrollerContainer"));timelineContainerElement.on("scroll",function(){tickHandlerScrollerContainerElement[0].scrollLeft=timelineContainerElement[0].scrollLeft}),tickHandlerElement.on("mousedown",function(event){$scope.isDisable||(event.preventDefault(),x=event.pageX-$scope.tick,originalTick=$scope.tick,$document.on("mousemove",tickHandlerMove),$document.on("mouseup",tickHandlerMoveEnd))})}}});